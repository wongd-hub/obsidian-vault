name: Copy to Quartz clone

on:
  push:
    branches:
      - main  # or your default branch

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout obsidian-vault
        uses: actions/checkout@v3
        with:
          path: obsidian-vault

      - name: Checkout obsidian-quartz
        uses: actions/checkout@v3
        with:
          repository: wongd-hub/obsidian-quartz
          path: obsidian-quartz
          token: ${{ secrets.REPO_ACCESS_TOKEN }}

      - name: Copy obsidian-vault contents to obsidian-quartz/content
        run: |
          rsync -av --progress obsidian-vault/ obsidian-quartz/content/ --exclude notes --exclude private --exclude _index.md --exclude .trash --exclude .github --exclude .gitignore --exclude README.md --exclude .git
          
      - name: Add front-matter to each .md file
        run: |
          cd obsidian-quartz/content
          find . -name "*.md" -exec sh -c 'grep -q "^---" "$1" || echo "---\ntitle: \"$(basename "${1%.*}")\"\n---\n$(cat "$1")" > "$1"' _ {} \;

      - name: Commit and push to obsidian-quartz if there's a change
        run: |
          cd obsidian-quartz
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Action"
          git remote set-url origin https://${{ secrets.REPO_ACCESS_TOKEN }}@github.com/wongd-hub/obsidian-quartz.git
          git add .
          if git diff --quiet HEAD; then
            echo "No changes detected. Nothing to commit."
            exit 0
          fi
          git commit -m "Sync obsidian-vault to obsidian-quartz"
          git push
  
